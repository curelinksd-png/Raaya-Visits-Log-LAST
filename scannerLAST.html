<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Raaya Plus â€” Ù…Ø³Ø­ ÙˆØ§Ù„ØªØ­Ù‚Ù‚</title>
<link rel="icon" href="https://i.ibb.co/ZzLTwVKv/curelink.png">
<style>
  body{font-family: "Tajawal", Arial; background:#f3f9f6; margin:0; padding:18px; color:#0b3b2e}
  .wrap{max-width:820px;margin:12px auto}
  header{display:flex;justify-content:space-between;align-items:center}
  header img{height:56px}
  .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 26px rgba(0,0,0,.06);margin-top:14px}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid #e3efe6;margin:8px 0;text-align:center}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  button{background:#0f4f3a;color:#fff;border:0;padding:12px;border-radius:10px;cursor:pointer;font-weight:800}
  button.secondary{background:#fff;color:#0f4f3a;border:1px solid #dbeadb}
  #preview{margin-top:14px;border-radius:8px;overflow:hidden}
  .result{margin-top:14px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#f7fff8);border:1px solid rgba(11,74,52,.06)}
  .ok{color:#1b8a3a;font-weight:900} .bad{color:#d43d3d;font-weight:900}
  .small{font-size:13px;color:#666;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="https://i.ibb.co/ZzLTwVKv/curelink.png" alt="CureLink">
    <h2 style="margin:0;color:#0f4f3a">Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ â€” Raaya Plus</h2>
    <img src="https://i.ibb.co/jK5y61d/raaya.png" alt="Raaya" style="height:56px">
  </header>

  <div class="card">
    <p style="text-align:center;margin:6px 0;color:#0b6b52">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ø«Ù… Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹</p>

    <input id="hospital" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (Ù…Ø·Ù„ÙˆØ¨)">
    <div class="row">
      <input id="manual" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ø­Ø±Ù + Ø£Ø±Ù‚Ø§Ù… Ø­ØªÙ‰ 50)" style="flex:1">
      <button id="btnCheck" class="secondary" style="width:160px">ğŸ” ØªØ­Ù‚Ù‚ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</button>
    </div>

    <div style="margin-top:10px">
      <button id="btnScan">ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù…Ø³Ø­ QR</button>
    </div>

    <div id="preview"></div>

    <div id="status" class="small"></div>

    <div id="result" class="result" style="display:none">
      <div><b>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹:</b> <span id="r_name">â€”</span></div>
      <div><b>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</b> <span id="r_card">â€”</span></div>
      <div><b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</b> <span id="r_exp">â€”</span></div>
      <div id="r_state" style="margin-top:8px"></div>
      <div class="small" id="r_msg"></div>
    </div>

    <div class="small" style="text-align:center;margin-top:12px">Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ Ø²ÙŠØ§Ø±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ø³Ø¬Ù„Ø§Øª Raaya Visits Log</div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
<script>
/* ===== Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ù†Ø´Ø± Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª ===== */
const LOOKUP_API_URL = "https://script.google.com/macros/s/AKfycbyDJkdHFOzsqgUuXtGe3Shxqi5J91l3OJyHoC7GR4U_nEJQHl93PWhSrHy977L1Rs4h/exec";   // â† Ø¶Ø¹ Ø±Ø§Ø¨Ø· doGet Ù…Ù† Ø´ÙŠØª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (Ø§Ù„Ù†Ø§ØªØ¬ Ø¹Ù† Deploy)
const VISIT_API_URL  = "https://script.google.com/macros/s/AKfycbyX6kQ3KLarILI9hlKkXavs5kckdDjYvd4sVWa3YLGUVbJ1glp8wTIpZ79rQjzB0oIoKg/exec";    // â† Ø¶Ø¹ Ø±Ø§Ø¨Ø· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª (Raaya Visits Log) (deploy)

const hospitalEl = document.getElementById('hospital');
const manualEl = document.getElementById('manual');
const btnCheck = document.getElementById('btnCheck');
const btnScan = document.getElementById('btnScan');
const preview = document.getElementById('preview');
const status = document.getElementById('status');
const result = document.getElementById('result');
const r_name = document.getElementById('r_name');
const r_card = document.getElementById('r_card');
const r_exp = document.getElementById('r_exp');
const r_state = document.getElementById('r_state');
const r_msg = document.getElementById('r_msg');

let scanner = null;
let scanning = false;

/* ===== Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® (Ù…Ø±Ù†Ø©) ===== */
function parseDateFlexible(s) {
  if(!s) return null;
  const iso = new Date(s);
  if(!isNaN(iso)) return iso;
  const m = s.match(/(\d{1,2})\D(\d{1,2})\D(\d{2,4})/);
  if(m){ const d=new Date((m[3].length===2?2000+parseInt(m[3]):parseInt(m[3])), parseInt(m[2])-1, parseInt(m[1])); if(!isNaN(d)) return d; }
  return null;
}
function expiryStatus(expiryStr){
  const d = parseDateFlexible(expiryStr);
  if(!d) return { ok:false, text:'ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' };
  const today = new Date(); today.setHours(0,0,0,0); d.setHours(0,0,0,0);
  return d >= today ? { ok:true, text:'ğŸŸ¢ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙØ¹Ù‘Ø§Ù„Ø© ÙˆØµØ§Ù„Ø­Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….' } : { ok:false, text:'ğŸ”´ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯.' };
}

/* ===== Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ lookup API ===== */
async function lookup(cardNumber, rawQR) {
  status.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
  result.style.display = 'none';
  try {
    const params = new URLSearchParams();
    if(cardNumber) params.set('cardNumber', cardNumber);
    if(rawQR) params.set('rawQR', rawQR);
    const res = await fetch(LOOKUP_API_URL + '?' + params.toString());
    const j = await res.json();
    return j;
  } catch(e) {
    console.error(e);
    status.textContent = 'âš ï¸ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ØªØ­Ù‚Ù‚';
    return null;
  }
}

/* ===== Ø¥Ø±Ø³Ø§Ù„ Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© ===== */
async function sendVisit(hospital, name, cardNumber, statusText, rawQR) {
  if(!VISIT_API_URL) return;
  try {
    const params = new URLSearchParams({
      action: 'visit',
      hospital: hospital,
      name: name,
      cardNumber: cardNumber,
      status: statusText,
      rawQR: rawQR
    });
    await fetch(VISIT_API_URL + '?' + params.toString());
  } catch(e){
    console.warn('visit log failed', e);
  }
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ===== */
function showData(data, rawQR){
  result.style.display = 'block';
  r_name.textContent = data.name || data.Ø§Ù„Ø§Ø³Ù…_Ø§Ù„ÙƒØ§Ù…Ù„ || '';
  r_card.textContent = data.cardNumber || data.Ø±Ù‚Ù…_Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© || '';
  r_exp.textContent = data.expiry || data.ØªØ§Ø±ÙŠØ®_Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ || '';
  const st = expiryStatus(r_exp.textContent);
  r_state.textContent = st.text;
  r_state.className = st.ok ? 'ok' : 'bad';
  r_msg.textContent = '';
  status.textContent = st.ok ? 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚' : 'âš ï¸ Ù…Ù†ØªÙ‡ÙŠ';
  // Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©
  sendVisit(hospitalEl.value.trim(), r_name.textContent, r_card.textContent, st.ok ? 'ÙØ¹Ø§Ù„Ø©' : 'Ù…Ù†ØªÙ‡ÙŠØ©', rawQR || '');
}

/* ===== ØªØ­Ù‚Ù‚ ÙŠØ¯ÙˆÙŠ ===== */
btnCheck.addEventListener('click', async ()=>{
  if(!hospitalEl.value.trim()){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰'); return; }
  const val = manualEl.value.trim();
  if(!val){ alert('Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©'); return; }
  const j = await lookup(val, '');
  if(!j){ return; }
  if(j.success && j.data){
    showData(j.data, '');
  } else if(j.name && j.cardNumber){
    // ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙŠØ±Ø¬Ø¹ Ø§Ù„ÙƒØ§Ø¦Ù† Ù…Ø¨Ø§Ø´Ø±Ø©
    showData(j, '');
  } else {
    status.textContent = 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©';
  }
});

/* ===== Ù…Ø³Ø­ QR Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ===== */
btnScan.addEventListener('click', async ()=>{
  if(!hospitalEl.value.trim()){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰'); return; }
  if(scanning){
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­
    if(scanner){ await scanner.stop(); scanner.clear(); }
    preview.innerHTML = ''; scanning = false; btnScan.textContent = 'ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù…Ø³Ø­ QR';
    return;
  }

  // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³Ø­
  preview.innerHTML = '<div id="reader" style="width:100%;max-width:520px;margin:12px auto"></div>';
  scanning = true; btnScan.textContent = 'â›” Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­';
  scanner = new Html5Qrcode("reader");

  try {
    await scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      async (decodedText) => {
        // ØªÙ… Ø§Ù„Ù…Ø³Ø­
        if(scanner){ await scanner.stop(); scanner.clear(); }
        scanning = false; btnScan.textContent = 'ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù…Ø³Ø­ QR';
        preview.innerHTML = '';
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø¨Ø·Ø§Ù‚Ø© Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù…Ø³ÙˆØ­
        let extracted = decodedText;
        const m = decodedText.match(/(?:Ø±Ù‚Ù…\s*Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©|cardNumber|card)\D*([A-Za-z0-9\-]{3,60})/i);
        if(m && m[1]) extracted = m[1];
        // Ø£ÙˆÙ„Ù‹Ø§ Ù†Ø·Ù„Ø¨ lookup Ø¨ cardNumber Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ØŒ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙ†Ø¬Ø­ Ù†Ø·Ù„Ø¨ rawQR
        let j = await lookup(extracted, '');
        if(j && j.success && j.data) {
          showData(j.data, decodedText);
        } else {
          // Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ rawQR
          j = await lookup('', decodedText);
          if(j && j.success && j.data) showData(j.data, decodedText);
          else status.textContent = 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©';
        }
      },
      (err) => {
        // scanning ongoing
      }
    );
  } catch(e){
    console.error(e);
    status.textContent = 'âš ï¸ ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â€” Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± https Ø£Ùˆ Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù„Ù„Ù…ØªØµÙØ­';
    scanning = false; btnScan.textContent = 'ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù…Ø³Ø­ QR';
  }
});
</script>
</body>
</html>
