<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Raaya Plus — مسح والتحقق</title>
<link rel="icon" href="https://i.ibb.co/ZzLTwVKv/curelink.png">
<style>
  body{font-family: "Tajawal", Arial; background:#f3f9f6; margin:0; padding:18px; color:#0b3b2e}
  .wrap{max-width:820px;margin:12px auto}
  header{display:flex;justify-content:space-between;align-items:center}
  header img{height:56px}
  .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 26px rgba(0,0,0,.06);margin-top:14px}
  input{width:100%;padding:12px;border-radius:10px;border:1px solid #e3efe6;margin:8px 0;text-align:center}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  button{background:#0f4f3a;color:#fff;border:0;padding:12px;border-radius:10px;cursor:pointer;font-weight:800}
  button.secondary{background:#fff;color:#0f4f3a;border:1px solid #dbeadb}
  #preview{margin-top:14px;border-radius:8px;overflow:hidden}
  .result{margin-top:14px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#f7fff8);border:1px solid rgba(11,74,52,.06)}
  .ok{color:#1b8a3a;font-weight:900} .bad{color:#d43d3d;font-weight:900}
  .small{font-size:13px;color:#666;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="https://i.ibb.co/ZzLTwVKv/curelink.png" alt="CureLink">
    <h2 style="margin:0;color:#0f4f3a">نظام التحقق — Raaya Plus</h2>
    <img src="https://i.ibb.co/jK5y61d/raaya.png" alt="Raaya" style="height:56px">
  </header>

  <div class="card">
    <p style="text-align:center;margin:6px 0;color:#0b6b52">أدخل اسم المستشفى ثم امسح الكود أو أدخل رقم البطاقة يدوياً</p>

    <input id="hospital" placeholder="اسم المستشفى (مطلوب)">
    <div class="row">
      <input id="manual" placeholder="رقم البطاقة (اختياري — حرف + أرقام حتى 50)" style="flex:1">
      <button id="btnCheck" class="secondary" style="width:160px">🔎 تحقق برقم البطاقة</button>
    </div>

    <div style="margin-top:10px">
      <button id="btnScan">📷 تشغيل الكاميرا لمسح QR</button>
    </div>

    <div id="preview"></div>

    <div id="status" class="small"></div>

    <div id="result" class="result" style="display:none">
      <div><b>اسم المراجع:</b> <span id="r_name">—</span></div>
      <div><b>رقم البطاقة:</b> <span id="r_card">—</span></div>
      <div><b>تاريخ الانتهاء:</b> <span id="r_exp">—</span></div>
      <div id="r_state" style="margin-top:8px"></div>
      <div class="small" id="r_msg"></div>
    </div>

    <div class="small" style="text-align:center;margin-top:12px">سيتم تسجيل كل زيارة تلقائيًا في سجلات Raaya Visits Log</div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
<script>
/* ===== عدّل الروابط هنا بعد نشر السكربتات ===== */
const LOOKUP_API_URL = "https://script.google.com/macros/s/AKfycbyDJkdHFOzsqgUuXtGe3Shxqi5J91l3OJyHoC7GR4U_nEJQHl93PWhSrHy977L1Rs4h/exec";   // ← ضع رابط doGet من شيت البطاقات (الناتج عن Deploy)
const VISIT_API_URL  = "https://script.google.com/macros/s/AKfycbyX6kQ3KLarILI9hlKkXavs5kckdDjYvd4sVWa3YLGUVbJ1glp8wTIpZ79rQjzB0oIoKg/exec";    // ← ضع رابط تسجيل الزيارات (Raaya Visits Log) (deploy)

const hospitalEl = document.getElementById('hospital');
const manualEl = document.getElementById('manual');
const btnCheck = document.getElementById('btnCheck');
const btnScan = document.getElementById('btnScan');
const preview = document.getElementById('preview');
const status = document.getElementById('status');
const result = document.getElementById('result');
const r_name = document.getElementById('r_name');
const r_card = document.getElementById('r_card');
const r_exp = document.getElementById('r_exp');
const r_state = document.getElementById('r_state');
const r_msg = document.getElementById('r_msg');

let scanner = null;
let scanning = false;

/* ===== مساعدة لتحليل التواريخ (مرنة) ===== */
function parseDateFlexible(s) {
  if(!s) return null;
  const iso = new Date(s);
  if(!isNaN(iso)) return iso;
  const m = s.match(/(\d{1,2})\D(\d{1,2})\D(\d{2,4})/);
  if(m){ const d=new Date((m[3].length===2?2000+parseInt(m[3]):parseInt(m[3])), parseInt(m[2])-1, parseInt(m[1])); if(!isNaN(d)) return d; }
  return null;
}
function expiryStatus(expiryStr){
  const d = parseDateFlexible(expiryStr);
  if(!d) return { ok:false, text:'تاريخ انتهاء غير معروف' };
  const today = new Date(); today.setHours(0,0,0,0); d.setHours(0,0,0,0);
  return d >= today ? { ok:true, text:'🟢 البطاقة فعّالة وصالحة للاستخدام.' } : { ok:false, text:'🔴 انتهت صلاحية البطاقة، الرجاء التجديد.' };
}

/* ===== استدعاء lookup API ===== */
async function lookup(cardNumber, rawQR) {
  status.textContent = '⏳ جاري التحقق...';
  result.style.display = 'none';
  try {
    const params = new URLSearchParams();
    if(cardNumber) params.set('cardNumber', cardNumber);
    if(rawQR) params.set('rawQR', rawQR);
    const res = await fetch(LOOKUP_API_URL + '?' + params.toString());
    const j = await res.json();
    return j;
  } catch(e) {
    console.error(e);
    status.textContent = '⚠️ خطأ اتصال بالتحقق';
    return null;
  }
}

/* ===== إرسال سجل الزيارة ===== */
async function sendVisit(hospital, name, cardNumber, statusText, rawQR) {
  if(!VISIT_API_URL) return;
  try {
    const params = new URLSearchParams({
      action: 'visit',
      hospital: hospital,
      name: name,
      cardNumber: cardNumber,
      status: statusText,
      rawQR: rawQR
    });
    await fetch(VISIT_API_URL + '?' + params.toString());
  } catch(e){
    console.warn('visit log failed', e);
  }
}

/* ===== عرض البيانات فى الواجهة ===== */
function showData(data, rawQR){
  result.style.display = 'block';
  r_name.textContent = data.name || data.الاسم_الكامل || '';
  r_card.textContent = data.cardNumber || data.رقم_البطاقة || '';
  r_exp.textContent = data.expiry || data.تاريخ_الانتهاء || '';
  const st = expiryStatus(r_exp.textContent);
  r_state.textContent = st.text;
  r_state.className = st.ok ? 'ok' : 'bad';
  r_msg.textContent = '';
  status.textContent = st.ok ? '✅ تم التحقق' : '⚠️ منتهي';
  // سجل الزيارة
  sendVisit(hospitalEl.value.trim(), r_name.textContent, r_card.textContent, st.ok ? 'فعالة' : 'منتهية', rawQR || '');
}

/* ===== تحقق يدوي ===== */
btnCheck.addEventListener('click', async ()=>{
  if(!hospitalEl.value.trim()){ alert('ادخل اسم المستشفى'); return; }
  const val = manualEl.value.trim();
  if(!val){ alert('ادخل رقم البطاقة'); return; }
  const j = await lookup(val, '');
  if(!j){ return; }
  if(j.success && j.data){
    showData(j.data, '');
  } else if(j.name && j.cardNumber){
    // في حال السكربت يرجع الكائن مباشرة
    showData(j, '');
  } else {
    status.textContent = '❌ لم يتم العثور على البطاقة';
  }
});

/* ===== مسح QR بالكاميرا ===== */
btnScan.addEventListener('click', async ()=>{
  if(!hospitalEl.value.trim()){ alert('ادخل اسم المستشفى'); return; }
  if(scanning){
    // إيقاف المسح
    if(scanner){ await scanner.stop(); scanner.clear(); }
    preview.innerHTML = ''; scanning = false; btnScan.textContent = '📷 تشغيل الكاميرا لمسح QR';
    return;
  }

  // إنشاء واجهة المسح
  preview.innerHTML = '<div id="reader" style="width:100%;max-width:520px;margin:12px auto"></div>';
  scanning = true; btnScan.textContent = '⛔ إيقاف المسح';
  scanner = new Html5Qrcode("reader");

  try {
    await scanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      async (decodedText) => {
        // تم المسح
        if(scanner){ await scanner.stop(); scanner.clear(); }
        scanning = false; btnScan.textContent = '📷 تشغيل الكاميرا لمسح QR';
        preview.innerHTML = '';
        // محاولة استخراج رقم بطاقة من النص الممسوح
        let extracted = decodedText;
        const m = decodedText.match(/(?:رقم\s*البطاقة|cardNumber|card)\D*([A-Za-z0-9\-]{3,60})/i);
        if(m && m[1]) extracted = m[1];
        // أولًا نطلب lookup ب cardNumber المستخرج، إذا لم ينجح نطلب rawQR
        let j = await lookup(extracted, '');
        if(j && j.success && j.data) {
          showData(j.data, decodedText);
        } else {
          // جرب البحث بالـ rawQR
          j = await lookup('', decodedText);
          if(j && j.success && j.data) showData(j.data, decodedText);
          else status.textContent = '❌ لم يتم العثور على البطاقة';
        }
      },
      (err) => {
        // scanning ongoing
      }
    );
  } catch(e){
    console.error(e);
    status.textContent = '⚠️ فشل تشغيل الكاميرا — افتح الصفحة عبر https أو منح الإذن للمتصفح';
    scanning = false; btnScan.textContent = '📷 تشغيل الكاميرا لمسح QR';
  }
});
</script>
</body>
</html>
